<!DOCTYPE html>
<html>

<head>
    <title>Gorilla</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="true">
    <script type="application/javascript">
        Gorilla = {}
    </script>

    <link rel="icon" href="/favicon.svg" />
    <link rel="stylesheet" type="text/css" href="font/komikatext_regular_macroman/stylesheet.css" />
    <link rel="stylesheet" type="text/css" href="components/podium/podium.css" />
    <script src="lib/jsxLoader.min.js"></script>
    <script src="lib/react.development.js"></script>
    <script src="lib/react-dom.development.js"></script>
    <script src="lib/react-router-dom.js"></script>
    <script src="lib/qrious.min.js"></script>
    <script nomodule src="lib/bundle.es5.js"></script>
    <script src="lib/bundle.esm.js" type="module"></script>
    <link rel="stylesheet" type="text/css" href="components/shell/shell.css" />
    <script src="components/shell/shell.js" type="text/babel"></script>
    <script src="components/general.js" type="text/babel"></script>
    <script src="components/entrance.js" type="text/babel"></script>
    <script src="components/host.js" type="text/babel"></script>
    <script src="components/play.js" type="text/babel"></script>
    <script src="components/podium/podium.js" type="text/babel"></script>
    <script src="components/podium/podium-final.js" type="text/babel"></script>
    <link rel="stylesheet" type="text/css" href="components/sticky/sticky-button.css" />
    <script src="components/sticky/sticky-button.js" type="text/babel"></script>
    <link rel="stylesheet" type="text/css" href="components/sticky/sticky-card.css" />
    <script src="components/sticky/sticky-card.js" type="text/babel"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        html,
        body,
        #react-root {
            margin: 0;
            height: 100%;
        }
    </style>
</head>

<body id="content" class="sapUiBody">
    <div id="react-root"></div>

    <script type="text/babel" data-type="module">
        'use strict'
        import WsClientAdapter from "./ws-client-adapter.js"

        Gorilla.HostGameWeb = function (props) {
            React.useEffect(() => music.current.play(), [])
            const music = React.useRef({})
            const { gameId } = ReactRouterDOM.useParams()
            const [volume, setVolume] = React.useState(1)
            music.current.volume = volume
            return <div style={{ height: "100%" }}>
                <Gorilla.HostGame gameId={gameId} adapter={props.adapter} volume={volume} />
                <audio ref={music} loop src="components/positive-funny-background-music-for-video-games.mp3"></audio>
                <Gorilla.AudioControl onVolume={setVolume} />
            </div>
        }

        Gorilla.PlayGameWeb = function (props) {
            const { gameId, playerName } = ReactRouterDOM.useParams()
            return <div style={{ height: "100%" }}>
                <Gorilla.PlayGame gameId={gameId} playerName={playerName} playerAvatar={props.avatar} adapter={props.adapter} />
            </div>
        }

        Gorilla.EnterGameWeb = function (props) {
            const { gameId } = ReactRouterDOM.useParams()
            const [playerName, setPlayerName] = React.useState('')
            const updatePlayerName = (event) => setPlayerName(event.target.value)
            const [errorMessage, setErrorMessage] = React.useState('')

            const errorToast = React.useRef(null)

            const join = async () => {
                // TODO do we get avatar back? and if yes, what to do with it?
                try {
                    const playerAvatar = await props.adapter.join(gameId, playerName)
                    props.onJoin(gameId, playerName, playerAvatar)
                } catch (error) {
                    setErrorMessage(error.message)
                    errorToast.current.show()
                }
            }

            return <div style={{ display: "flex", flexDirection: "column" }}>
                <ui5-title level="H1">Game {gameId}</ui5-title>
                <ui5-label for="playerName" required>Name</ui5-label>
                <ui5-input style={{ width: "100%" }} id="playerName" placeholder="Enter your name" value={playerName} onInput={updatePlayerName}></ui5-input>
                <ui5-button style={{ width: "100%" }} onClick={join}>Join</ui5-button>
                <ui5-toast ref={errorToast}>{errorMessage}</ui5-toast>
            </div>
        }

        Gorilla.WebApp = function (props) {
            const [avatar, setAvatar] = React.useState('')

            const { HashRouter, Switch, Route } = ReactRouterDOM

            const join = (gameId, playerName, playerAvatar) => {
                window.location = `#/play/${gameId}/${playerName}`
                setAvatar(playerAvatar)
            }

            const host = (gameId) => {
                window.location = `#/host/${gameId}`
            }

            return <div style={{ height: "100%", width: "100%" }}>
                <HashRouter>
                    <Switch>
                        <Route exact path="/">
                            <Gorilla.Entrance onHost={host} adapter={props.adapter} />
                        </Route>
                        <Route path="/play/:gameId/:playerName">
                            <Gorilla.PlayGameWeb adapter={props.adapter} avatar={avatar} />
                        </Route>
                        <Route path="/play/:gameId">
                            <Gorilla.EnterGameWeb adapter={props.adapter} onJoin={join} />
                        </Route>
                        <Route path="/host/:gameId">
                            <Gorilla.HostGameWeb adapter={props.adapter} />
                        </Route>
                    </Switch>
                </HashRouter>
                <p />
            </div>
        }

        ReactDOM.render(<Gorilla.WebApp adapter={new WsClientAdapter(io())} />, document.querySelector('#react-root'))
    </script>
</body>

</html>